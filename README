# FreeIPA server in Docker

This repository contains the Dockerfile and associated assets for
building a FreeIPA server Docker image from the official yum repo.

### WARNING: this is a modified version that waits for an external
###    network configuration, see below!

Install docker 1.2+:

    yum install -y docker-io	# on Fedoras
    yum install -y docker	# on RHEL 7

Start the service:

    systemctl start docker

To build the image, run in the root of the repository:

    docker build -t freeipa-server .

Create directory which will hold the server data:

    mkdir /var/lib/ipa-data

You can optionally put into this directory a file

    ipa-server-install-options

with command line parameters to ipa-server-install command, one
parameter per line. You probably want at least

    --ds-password=The-directory-server-password
    --admin-password=The-admin-password

If you want to create a replica instead of master, put the GPG-encrypted
replica information file to this directory, plus file

    ipa-replica-install-options

to instruct the container to create a replica. That file should contain
command line parameters to the ipa-replica-install command, possibly at
least

    --password=The-directory-server-password
    --admin-password=The-admin-password

You then run the container with

    docker run --name freeipa-server-container -ti \
       -h ipa.example.test \
       -v /var/lib/ipa-data:/data:Z freeipa-server

If you do not specify the passwords in the ipa-server-install-options
file, use `PASSWORD` environment variable via the `-e` option:

    docker run --name freeipa-server-container -ti \
       -h ipa.example.test -e PASSWORD=Secret123 \
       -v /var/lib/ipa-data:/data:Z freeipa-server

If the above fails with error about invalid value for flag -v
and bad format for volumes, run

    chcon -t svirt_sandbox_file_t /var/lib/ipa-data

or use semanage fcontext and restorecon, and use -v option
without the :Z part.

The option `--name` assigns the container a name that can be used
later with `docker start`, `docker stop` and other commands.
Command `ipa-server-install` is invoked non-interactively the first
time the container is run.

You can pass environment variable IPA_SERVER_INSTALL_OPTS with
additional options that will be passed to ipa-server-install.

The `-ti` parameters are optional and are used for get a terminal
(useful for experimenting in the container).

The container can the be started and stopped:

    docker stop freeipa-server-container
    docker start -ai freeipa-server-container

If you want to use the FreeIPA server not just from the host
where it is running but from external machines as well, you
might want to use the `-p` options to make the services accessible
externally. You will then likely want to also specify the
`IPA_SERVER_IP` environment variable via the `-e` option to
define what IP address should the server put to DNS as its
address. Starting the server would then be

    docker run -e IPA_SERVER_IP=10.12.0.98 -p 53:53/udp -p 53:53 \
        -p 80:80 -p 443:443 -p 389:389 -p 636:636 -p 88:88 -p 464:464 \
	-p 88:88/udp -p 464:464/udp -p 123:123/udp -p 7389:7389 \
	-p 9443:9443 -p 9444:9444 -p 9445:9445 ...

### WARNING: the current installation code waits unconditionally for
###   the network. Read on.

However, the IPA_SERVER_IP option does not really work well with
addresses that are not bound on the docker bridge. The server setup
gets confused and adds e.g. reverse zones for the docker IP instead
of the specified IP.

A better option is to add a virtual ethernet device that is configured
with the IP specified, which can be routed on the host so that all clients
can reach it.

Running the container this way requires the following invocation
(from a proof of concept):

    docker run --name ipa1 -d --cap-add=SYS_TIME \
	-h ipa1.fqdn -v /var/lib/ipa-data:/data:Z \
	-e IPA_SERVER_IP=10.12.0.98 freeipa-server:centos-7-upstream-network

The process will wait until a configured eth1 device is found inside
the netns. This can be provided by the following sequence of commands
from the host:

    mkdir -p /var/run/netns
    IPAPID=$(/usr/bin/docker inspect --format='{{ .State.Pid }}' ipa1)
    ln -sf /proc/${IPAPID}/ns/net /var/run/netns/ipa1
    ip link add veth0-ipa1 type veth peer name veth1-ipa1
    ip link set dev veth1-ipa1 netns ipa1
    ip netns exec ipa1 ip link set veth1-ipa1 name eth1
    ip netns exec ipa1 ip addr dev eth1 local 10.12.0.98/24 broadcast +
    ip link set dev veth0-ipa1 up
    ip netns exec ipa1 ip link set eth1 up

For connectivity from the host to the container, simply add the veth0-ipa1
device to a bridge with fixed IP address in the same range.

To create a replica with a fixed IP, use the same process as documented
above, but also specify the IPA master server details in additional
docker environment variables so the correct hostname can be resolved:

    docker run --name ipa2 -d --cap-add=SYS_TIME \
	-h ipa2.fqdn -v /var/lib/ipa-data-replica:/data:Z \
	-e IPA_SERVER_IP=10.12.0.99 \
	-e IPA_MASTER_IP=10.12.0.98 \
	-e IPA_MASTER_FQDN=ipa1.fqdn \
	-e IPA_MASTER_SHORT=ipa1 \
	freeipa-server:centos-7-upstream-network

Of course, this container also needs the eth1 virtual interface setup
analogous to above.

# IPA-enrolled client in Docker

There are multiple `*-client` branches named after OS they are
based on. Check out the branch you prefer and in the root of the
repository, run:

    docker build -t freeipa-client .

To run the client container, run it with correctly set DNS
and hostname in the IPA domain, or you can link it to the
freeipa-server container directly:

    docker run --privileged --link freeipa-server-container:ipa \
        -e PASSWORD=Secret123 -ti freeipa-client

The first time this container runs, it invokes `ipa-client-install`
with the given admin password.

# Copyright 2014--2015 Jan Pazdziora

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
